This quickstart shows how to setup a Java (Maven+Springboot) project that uses a [CloudBees platform](https://www.cloudbees.com/products/saas-platform) workflow to build the Java application into a JAR file that is published as a runnable container image.


## Building and publishing containerized Java applications using CloudBees workflows


When automating the delivery of your Java-based software components, workflows need to be able to execute steps that use the Java and Maven tool-sets.  The [`workflow.yaml`](./cloudbees/workflows/workflow.yaml) file in this project shows how to leverage a `maven` container image to build the project into a self-contained JAR file.  The [kaniko](https://docs.cloudbees.com/docs/cloudbees-saas-platform/latest/deploy-tools/kaniko) action can then be used to build and publish the app as a container image that can be deployed into container-friendly runtimes (Kubernetes, AWS ECS, etc). 


## Building maven-based Java apps using a workflow

To build your Java application using `mvn` CLI commands, define a job to check out the project source code and then add a command step to run the required commands using the appropriate container for your preferred version of Maven and Java.

```
jobs:
  build-and-publsh:
    steps:
      - name: Checkout
        uses: cloudbees-io/checkout@v1

      - name: Build JAR
        uses: docker://maven:3.9.6-eclipse-temurin-17
        shell: sh
        run: |
          mvn clean install
```


* The `Checkout code` step uses the [`cloudbees-io/checkout`](https://docs.cloudbees.com/docs/cloudbees-saas-platform/latest/source-code-management/checkout) action to pull down the repository source code into the current directory (also known as the `cloudbees.workspace` directory). 
* The `Build JAR` command step runs the required `mvn` commands using the `maven:3.9.6-eclipse-temurin-17` container.


Based on [`pom.xml`](./pom.xml) file in this project, this workflow job will produce a runnable JAR file in the `target/` directory named `quickstart-java-app.jar`. 

## Building and publishing a Java app as a container image

Once the Java app is built into a runnable JAR file, it can be transformed into a container image by defining a Dockerfile and then using the [kaniko](https://docs.cloudbees.com/docs/cloudbees-saas-platform/latest/deploy-tools/kaniko) action to build abd publish the container image.

### 
The [Dockerfile](./Dockerfile) in this project is designed to pull the JAR file into the container image and runs it using a base image that supports the Java Runtime Environment (JRE).

```
# Use a Java 17 base image to run the app
FROM eclipse-temurin:17-jre

# Set the working directory in the container
WORKDIR /app

# Copy the built JAR file to the container
COPY ./target/quickstart-java-app.jar .

# Set the command to run the application
CMD ["java", "-jar", "quickstart-java-app.jar"]
```

To automate the building and publishing of the container image, the following steps are added to [`workflow.yaml`](.cloudbees/workflows/workflow.yaml) 

```
      - name: Configure container registry
        uses: cloudbees-io/configure-oci-credentials@v1
        with:
          registry: index.docker.io # or docker.io
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and publish container image
        uses: cloudbees-io/kaniko@v1
        with:
          destination: ${{ vars.DOCKERHUB_USERNAME }}/quickstart-java-app:${{ cloudbees.version }}
```

* The `Configure container registry` step uses the [`cloudbees-io/configure-oci-credentials`](https://docs.cloudbees.com/docs/cloudbees-saas-platform/latest/credentials/configure-oci-credentials) action initialize the credentials for an OCI-compatible container registry.  In this case, the targeted registry is Dockerhub, but other container registries are also supported (ex: GitHub Container Registry,  AWS Elastic Container Registry, or JFrog Artifactory).
* The `Build and publish container image` step uses the [cloudbees-io/kaniko](https://docs.cloudbees.com/docs/cloudbees-saas-platform/latest/deploy-tools/kaniko) action to build and publish the container image to the target container registry.
* The steps leverage a few externally configured variables that are maintained outside the workflow:
  * `vars.DOCKERHUB_USERNAME` - accesses the DOCKERHUB_USERNAME configuration property value for this workflow.
  * `secrets.DOCKERHUB_PASSWORD` - accesses the *secret* DOCKERHUB_PASSWORD configuration property value for this workflow.
  * `cloudbees.version` - accesses an incrementing version string that is automatcally generated by the cloudbees platform. This is used to assign a new version each time a new container image is generated.